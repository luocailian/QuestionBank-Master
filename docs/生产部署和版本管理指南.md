# QuestionBank Master 生产部署和版本管理指南

## 概述

本指南提供了完整的生产级Docker部署方案，支持零停机版本更迭、自动备份、监控告警等企业级功能。

## 部署架构

### 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx LB      │    │   Frontend      │    │   Backend       │
│   (负载均衡)     │────│   (Vue.js)      │────│   (Flask)       │
│   Port: 8080    │    │   Port: 80      │    │   Port: 5000    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                └───────────┬───────────┘
                                           │
                       ┌─────────────────┐ │ ┌─────────────────┐
                       │     MySQL       │ │ │     Redis       │
                       │   Port: 3306    │ │ │   Port: 6379    │
                       └─────────────────┘   └─────────────────┘
```

### 核心特性
- **零停机部署**: 蓝绿部署策略
- **自动备份**: 数据库、文件、日志自动备份
- **健康监控**: 实时监控服务状态和性能
- **版本管理**: 完整的版本控制和回滚机制
- **安全加固**: SSL/TLS、防火墙、访问控制
- **性能优化**: 缓存、压缩、负载均衡

## 快速部署

### 1. Docker Compose 部署（推荐）
```bash
# 克隆项目
git clone <repository-url>
cd questionbank-master

# 配置环境变量
cp .env.prod.example .env.prod
vim .env.prod

# 启动生产环境
docker-compose -f docker-compose.prod.yml up -d --build
```

### 2. 手动部署步骤

#### 步骤1: 环境准备
```bash
# 复制环境配置
cp .env.prod.example .env.prod

# 编辑配置文件
vim .env.prod
```

#### 步骤2: 配置环境变量
```bash
# 必须配置的变量
VERSION=v1.0.0
MYSQL_ROOT_PASSWORD=your_secure_password
MYSQL_PASSWORD=your_db_password
SECRET_KEY=your_32_char_secret_key
JWT_SECRET_KEY=your_32_char_jwt_key
VITE_API_BASE_URL=https://your-domain.com/api/v1
DOMAIN=your-domain.com
```

#### 步骤3: 启动服务
```bash
# 构建并启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps
```

## 版本管理

### 版本管理工具
```bash
# 查看所有可用版本
./scripts/version-manager.sh list

# 查看当前版本
./scripts/version-manager.sh current

# 部署新版本
./scripts/version-manager.sh deploy v1.2.0

# 回滚到上一版本
./scripts/version-manager.sh rollback

# 回滚到指定版本
./scripts/version-manager.sh rollback v1.1.0

# 创建新版本标签
./scripts/version-manager.sh tag v1.3.0 "新增用户管理功能"

# 查看版本历史
./scripts/version-manager.sh history

# 清理旧版本
./scripts/version-manager.sh cleanup
```

### 零停机部署流程

#### 蓝绿部署策略
1. **构建新版本镜像**
   ```bash
   docker build -f backend/Dockerfile.prod -t questionbank/backend:v1.2.0 backend/
   docker build -f frontend/Dockerfile.prod -t questionbank/frontend:v1.2.0 frontend/
   ```

2. **启动绿色环境**
   ```bash
   export VERSION=v1.2.0
   docker-compose -f docker-compose.prod.yml up -d --no-deps backend frontend
   ```

3. **健康检查**
   ```bash
   # 等待服务健康
   ./scripts/monitor.sh
   ```

4. **切换流量**
   ```bash
   # 更新负载均衡器配置
   docker-compose -f docker-compose.prod.yml restart nginx-lb
   ```

5. **验证部署**
   ```bash
   # 验证新版本功能
   curl -f http://localhost:5000/api/v1/health
   curl -f http://localhost/health
   ```

6. **清理旧版本**
   ```bash
   # 清理旧镜像
   ./scripts/version-manager.sh cleanup
   ```

### 回滚机制

#### 自动回滚
- 健康检查失败时自动回滚
- 部署超时时自动回滚
- 关键错误时自动回滚

#### 手动回滚
```bash
# 快速回滚到上一版本
./scripts/version-manager.sh rollback

# 回滚到指定版本
./scripts/version-manager.sh rollback v1.1.0
```

## 备份和恢复

### 自动备份
```bash
# 执行完整备份
./scripts/backup.sh

# 查看备份文件
ls -la backups/
```

### 备份内容
- **数据库备份**: MySQL完整备份
- **文件备份**: 上传文件备份
- **日志备份**: 应用日志备份
- **配置备份**: 配置文件备份

### 恢复数据
```bash
# 恢复数据库
gunzip < backups/database/db_backup_20231201_020000.sql.gz | \
docker exec -i questionbank_mysql mysql -u root -p questionbank_master

# 恢复文件
tar -xzf backups/uploads/uploads_backup_20231201_020000.tar.gz
```

## 监控和告警

### 系统监控
```bash
# 执行系统监控
./scripts/monitor.sh

# 查看监控报告
cat logs/monitor_report_$(date +%Y%m%d).log
```

### 监控指标
- **服务状态**: 容器运行状态
- **健康检查**: API响应状态
- **资源使用**: CPU、内存、磁盘
- **性能指标**: 响应时间、吞吐量
- **错误日志**: 应用错误统计

### 告警配置
```bash
# 配置告警阈值
export CPU_THRESHOLD=80
export MEMORY_THRESHOLD=80
export DISK_THRESHOLD=85
export RESPONSE_TIME_THRESHOLD=5000
```

## 安全配置

### SSL/TLS配置
```bash
# 生成SSL证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout nginx/ssl/key.pem \
    -out nginx/ssl/cert.pem
```

### 防火墙配置
```bash
# 开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw enable
```

### 访问控制
- API限流配置
- 登录频率限制
- IP白名单配置

## 性能优化

### 数据库优化
```sql
-- 索引优化
CREATE INDEX idx_user_id ON user_answers(user_id);
CREATE INDEX idx_bank_id ON questions(bank_id);
CREATE INDEX idx_created_at ON question_banks(created_at);

-- 查询优化
ANALYZE TABLE question_banks;
ANALYZE TABLE questions;
ANALYZE TABLE user_answers;
```

### 缓存配置
```bash
# Redis缓存配置
echo "maxmemory 256mb" >> redis/redis.conf
echo "maxmemory-policy allkeys-lru" >> redis/redis.conf
```

### Nginx优化
```nginx
# 启用gzip压缩
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## 故障排除

### 常见问题

#### 1. 容器启动失败
```bash
# 查看容器日志
docker-compose -f docker-compose.prod.yml logs backend

# 检查容器状态
docker ps -a
```

#### 2. 数据库连接失败
```bash
# 检查MySQL容器
docker exec questionbank_mysql mysql -u root -p -e "SHOW DATABASES;"

# 检查网络连接
docker network ls
docker network inspect questionbank_network
```

#### 3. 前端无法访问后端
```bash
# 检查Nginx配置
docker exec questionbank_frontend nginx -t

# 查看Nginx日志
docker logs questionbank_frontend
```

### 日志分析
```bash
# 查看应用日志
tail -f logs/error.log

# 查看访问日志
tail -f logs/nginx/access.log

# 查看系统日志
journalctl -u docker -f
```

## 维护操作

### 定期维护
```bash
# 每日备份
0 2 * * * /path/to/scripts/backup.sh

# 每周清理
0 3 * * 0 /path/to/scripts/cleanup.sh

# 每月更新
0 4 1 * * /path/to/scripts/update.sh
```

### 系统更新
```bash
# 更新系统包
apt update && apt upgrade -y

# 更新Docker镜像
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

## 扩展部署

### 水平扩展
```yaml
# docker-compose.scale.yml
services:
  backend:
    deploy:
      replicas: 3
  
  frontend:
    deploy:
      replicas: 2
```

### 负载均衡
```nginx
upstream backend_pool {
    server backend1:5000;
    server backend2:5000;
    server backend3:5000;
}
```

### 数据库集群
```yaml
services:
  mysql-master:
    image: mysql:8.0
    environment:
      MYSQL_REPLICATION_MODE: master
  
  mysql-slave:
    image: mysql:8.0
    environment:
      MYSQL_REPLICATION_MODE: slave
      MYSQL_MASTER_HOST: mysql-master
```

## 总结

本部署方案提供了：
- ✅ **完整的生产级配置**
- ✅ **零停机版本更迭**
- ✅ **自动化备份和恢复**
- ✅ **实时监控和告警**
- ✅ **安全加固和性能优化**
- ✅ **故障排除和维护指南**

通过这套方案，你可以安全、稳定地在生产环境中运行QuestionBank Master，并实现无缝的版本更新。
